{% extends "base.html" %}
{% block title %}Crop Suggestions - Agri Drain{% endblock %}

{% block content %}
<div class="suggestion-page">
  <h2 class="page-title">üå± Crop Suggestions & Planting Guide</h2>
  
  <div class="farmer-info-card">
    <h3>üë®‚Äçüåæ Farmer Information</h3>
    <div class="info-grid">
      <div class="info-item">
        <label>Name:</label>
        <span id="farmer-name">{{ session.get('farmer_name', 'Not provided') }}</span>
      </div>
      <div class="info-item">
        <label>Soil Type:</label>
        <span id="soil-type">{{ session.get('soil_type', 'Not provided') }}</span>
      </div>
      <div class="info-item">
        <label>Water Level:</label>
        <span id="water-level">{{ session.get('water_level', 'Not provided') }}</span>
      </div>
      <div class="info-item">
        <label>Selected Crop:</label>
        <span id="selected-crop">{{ session.get('selected_crop', 'Not provided') }}</span>
      </div>
    </div>
  </div>

  <!-- Crop Recommendation Section -->
  <div class="recommendation-section">
    <h3>üìä Recommended Crops for Your Farm</h3>
    <div class="crops-grid" id="recommended-crops">
      <!-- Crops will be populated by JavaScript -->
    </div>
  </div>

  <!-- Detailed Crop Guide -->
  <div class="crop-guide-section">
    <h3>üåæ Detailed Planting Guide for <span id="guide-crop-name">{{ session.get('selected_crop', 'Selected Crop') }}</span></h3>
    
    <div class="guide-tabs">
      <button class="tab-btn active" onclick="openTab('season-tab')">üìÖ Season & Timing</button>
      <button class="tab-btn" onclick="openTab('soil-tab')">üå± Soil Preparation</button>
      <button class="tab-btn" onclick="openTab('water-tab')">üíß Water Management</button>
      <button class="tab-btn" onclick="openTab('care-tab')">üõ†Ô∏è Crop Care</button>
    </div>

    <div id="season-tab" class="tab-content active">
      <h4>Planting Season & Timing</h4>
      <div id="season-info">
        <!-- Season info will be populated by JavaScript -->
      </div>
    </div>

    <div id="soil-tab" class="tab-content">
      <h4>Soil Preparation</h4>
      <div id="soil-info">
        <!-- Soil info will be populated by JavaScript -->
      </div>
    </div>

    <div id="water-tab" class="tab-content">
      <h4>Water Management</h4>
      <div id="water-info">
        <!-- Water info will be populated by JavaScript -->
      </div>
    </div>

    <div id="care-tab" class="tab-content">
      <h4>Crop Care & Maintenance</h4>
      <div id="care-info">
        <!-- Care info will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Additional Suggestions -->
  <div class="additional-suggestions">
    <h3>üí° Additional Farming Suggestions</h3>
    <div class="suggestion-cards">
      <div class="suggestion-card">
        <h4>üîÑ Crop Rotation</h4>
        <p id="rotation-suggestion">Rotate with legumes to improve soil nitrogen.</p>
      </div>
      <div class="suggestion-card">
        <h4>üåæ Intercropping</h4>
        <p id="intercropping-suggestion">Consider intercropping with compatible crops.</p>
      </div>
      <div class="suggestion-card">
        <h4>üíß Irrigation Tips</h4>
        <p id="irrigation-suggestion">Optimize water usage based on your water level.</p>
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="back-btn" onclick="window.location.href='/farmer'">‚Üê Back to Farmer Dashboard</button>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print This Guide</button>
  </div>
</div>

<style>
  .suggestion-page {
    max-width: 1200px;
    margin: 30px auto;
    padding: 20px;
  }

  .farmer-info-card {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    padding: 25px;
    border-radius: 15px;
    margin: 20px 0;
    border-left: 5px solid #4caf50;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: white;
    border-radius: 8px;
  }

  .info-item label {
    font-weight: bold;
    color: #2e7d32;
  }

  .recommendation-section {
    background: #f1f8e9;
    padding: 25px;
    border-radius: 15px;
    margin: 25px 0;
  }

  .crops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }

  .crop-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .crop-card:hover {
    transform: translateY(-5px);
    border-color: #4caf50;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .crop-card.selected {
    border-color: #4caf50;
    background: #e8f5e9;
  }

  .crop-icon {
    font-size: 2em;
    margin-bottom: 10px;
  }

  .crop-name {
    font-weight: bold;
    color: #2e7d32;
    margin-bottom: 5px;
  }

  .crop-season {
    font-size: 0.9em;
    color: #666;
  }

  .crop-guide-section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin: 25px 0;
    border: 2px solid #e8f5e9;
  }

  .guide-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background: #f1f8e9;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tab-btn.active {
    background: #4caf50;
    color: white;
  }

  .tab-content {
    display: none;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 10px;
    margin-top: 10px;
  }

  .tab-content.active {
    display: block;
  }

  .additional-suggestions {
    margin: 30px 0;
  }

  .suggestion-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .suggestion-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #ff9800;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
  }

  .back-btn, .print-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
  }

  .back-btn {
    background: #757575;
    color: white;
  }

  .print-btn {
    background: #2196f3;
    color: white;
  }

  .back-btn:hover {
    background: #616161;
  }

  .print-btn:hover {
    background: #1976d2;
  }
</style>

<script>
  // Crop database with detailed information
  const cropDatabase = {
    // Kharif Crops
    "Rice": {
      season: "Kharif (June-October)",
      icon: "üåæ",
      timing: "Sow: June-July, Harvest: October-November",
      soil: "Clayey loam with good water retention",
      water: "Requires standing water, ideal for high water levels",
      care: "Transplant seedlings, control weeds, manage water levels"
    },
    "Cotton": {
      season: "Kharif (June-December)",
      icon: "üßµ",
      timing: "Sow: June-July, Harvest: December-January",
      soil: "Black soil preferred, well-drained",
      water: "Moderate water requirements",
      care: "Regular weeding, pest control for bollworms"
    },
    // Add more crops as needed...
  };

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    loadRecommendedCrops();
    loadCropGuide();
    loadAdditionalSuggestions();
  });

  function loadRecommendedCrops() {
    const soilType = "{{ session.get('soil_type', '') }}";
    const waterLevel = "{{ session.get('water_level', '') }}";
    const selectedCrop = "{{ session.get('selected_crop', '') }}";
    
    // This would typically come from your backend
    const recommendedCrops = getRecommendedCrops(soilType, waterLevel);
    
    const cropsGrid = document.getElementById('recommended-crops');
    cropsGrid.innerHTML = '';
    
    recommendedCrops.forEach(crop => {
      const cropInfo = cropDatabase[crop] || {
        season: "Varies by region",
        icon: "üå±"
      };
      
      const cropCard = document.createElement('div');
      cropCard.className = `crop-card ${crop === selectedCrop ? 'selected' : ''}`;
      cropCard.innerHTML = `
        <div class="crop-icon">${cropInfo.icon}</div>
        <div class="crop-name">${crop}</div>
        <div class="crop-season">${cropInfo.season}</div>
      `;
      cropCard.onclick = function() {
        updateCropGuide(crop);
      };
      cropsGrid.appendChild(cropCard);
    });
  }

  function loadCropGuide() {
    const selectedCrop = "{{ session.get('selected_crop', 'Rice') }}";
    updateCropGuide(selectedCrop);
  }

  function updateCropGuide(cropName) {
    const cropInfo = cropDatabase[cropName] || {
      timing: "Information not available",
      soil: "Information not available",
      water: "Information not available",
      care: "Information not available"
    };

    document.getElementById('guide-crop-name').textContent = cropName;
    document.getElementById('season-info').innerHTML = `<p>${cropInfo.timing}</p>`;
    document.getElementById('soil-info').innerHTML = `<p>${cropInfo.soil}</p>`;
    document.getElementById('water-info').innerHTML = `<p>${cropInfo.water}</p>`;
    document.getElementById('care-info').innerHTML = `<p>${cropInfo.care}</p>`;
  }

  function loadAdditionalSuggestions() {
    const soilType = "{{ session.get('soil_type', '') }}";
    const waterLevel = "{{ session.get('water_level', '') }}";
    
    // Generate suggestions based on conditions
    document.getElementById('rotation-suggestion').textContent = 
      getRotationSuggestion(soilType);
    document.getElementById('intercropping-suggestion').textContent = 
      getIntercroppingSuggestion(soilType);
    document.getElementById('irrigation-suggestion').textContent = 
      getIrrigationSuggestion(waterLevel);
  }

  function openTab(tabName) {
    // Hide all tab contents
    const tabContents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < tabContents.length; i++) {
      tabContents[i].classList.remove('active');
    }

    // Remove active class from all buttons
    const tabButtons = document.getElementsByClassName('tab-btn');
    for (let i = 0; i < tabButtons.length; i++) {
      tabButtons[i].classList.remove('active');
    }

    // Show the specific tab content
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
  }

  // Helper functions (you would expand these)
  function getRecommendedCrops(soil, water) {
    // This would match your existing crop suggestions logic
    return ["Rice", "Wheat", "Cotton", "Sugarcane"].slice(0, 4);
  }

  function getRotationSuggestion(soil) {
    const suggestions = {
      "Black Soil": "Rotate cotton with legumes like soybean or pigeon pea",
      "Red Soil": "Rotate millets with pulses like green gram or black gram",
      "Alluvial Soil": "Rice-wheat rotation or add legumes in rotation",
      "Laterite Soil": "Include groundnut and pulses in rotation with cashew"
    };
    return suggestions[soil] || "Include legume crops in your rotation cycle";
  }

  function getIntercroppingSuggestion(soil) {
    // Return intercropping suggestions based on soil type
    return "Consider intercropping with compatible crops for better yield";
  }

  function getIrrigationSuggestion(water) {
    const suggestions = {
      "Low (Below 2m)": "Use drip irrigation and mulching to conserve water",
      "Moderate (2m - 5m)": "Schedule irrigation based on crop growth stages",
      "High (Above 5m)": "Ensure proper drainage to prevent waterlogging"
    };
    return suggestions[water] || "Optimize irrigation based on crop requirements";
  }
</script>
{% endblock %}